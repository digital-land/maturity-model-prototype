{% extends "dataset/base.html" %}
{% block page_title %}Brownfield land | Dataset performance | Maturity Model | Digital Land{% endblock %}
{%- from "digital-land-frontend/components/feedback-panel/macro.html" import dlFeedbackPanel %}
{% from 'macro/resources-sources-by-month.html' import sourcesAndResourcesByMonthChart, sourcesAndResourcesByMonthJS %}
{% from 'tables/org-table-on-dataset.html' import orgTableOnDataset %}

{% block dl_breadcrumbs %}
{{ govukBreadcrumbs({
  "items": [
    {
      "text": "Datasets",
      "href": url_for('base.dataset')
    },
    {
      "text": name|replace("-", " ")|capitalize
    }
  ]
}) }}
{% endblock %}

{% block content %}
<main id="content" role="main">
  <span class="govuk-caption-xl">Dataset performance</span>
  <h1 class="govuk-heading-xl">{{ name|replace("-", " ")|capitalize }}</h1>

  
  <div class="govuk-grid-row govuk-!-margin-bottom-2 govuk-!-margin-top-9">
    {% if entity_count is not none -%}
    <div class="govuk-grid-column-one-half">
      <div class="data-item govuk-!-margin-bottom-6">
        <span class="data-item__number govuk-!-font-size-80">{{ entity_count|commanum }}</span>
        <p class="govuk-body govuk-!-font-size-36">Entit{{ "y" if entity_count == 1 else "ies" }}</p>
      </div>
    </div>
    {%- endif %}
    {% if coverage -%}
    <div class="govuk-grid-column-one-quarter">
      <div class="data-item govuk-!-margin-bottom-6">
        <span class="data-item__number govuk-!-font-size-80">{{ coverage['publishers']|commanum }}<span class="govuk-!-font-size-19">/{{ coverage['expected_publishers']|commanum }}</span></span>
        <p class="govuk-body govuk-!-font-size-36">Publishers</p>
      </div>
    </div>
    {%- endif %}
    {% if resource_count is not none %}
    <div class="govuk-grid-column-one-quarter">
      <div class="data-item govuk-!-margin-bottom-6">
        <span class="data-item__number govuk-!-font-size-80">{{ resource_count['total']|default('0') }}</span>
        <p class="govuk-body govuk-!-font-size-36"><a class="govuk-link--text-colour" href="{{ url_for('base.resources', pipeline=name) }}">Resources</a></p>
      </div>
    </div>
    {% endif %}
  </div>

  <h3 class="govuk-heading-m">Dataset info</h3>
  <dl class="govuk-summary-list govuk-!-margin-bottom-9">

    {% if dataset['name'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Name
      </dt>
      <dd class="govuk-summary-list__value">
        {{ dataset['name'] }}
      </dd>
    </div>
    {% endif %}

    {% if dataset['project'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Project
      </dt>
      <dd class="govuk-summary-list__value">
        <a href="https://digital-land.github.io/project'{{ dataset['project'] }}">{{ dataset['project'] }}</a>
      </dd>
    </div>
    {% endif %}

    {% if dataset['pipeline'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Pipeline
      </dt>
      <dd class="govuk-summary-list__value">
        <a href="https://github.com/digital-land/{{ dataset['pipeline'] }}">{{ dataset['pipeline'] }}</a>
      </dd>
    </div>
    {% endif %}

    {% if dataset['data-provider'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Data provider
      </dt>
      <dd class="govuk-summary-list__value">
        {{ dataset['data-provider'] }}
      </dd>
    </div>
    {% endif %}

    {% if dataset['category'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Policy area
      </dt>
      <dd class="govuk-summary-list__value">
        {{ dataset['category'] }}
      </dd>
    </div>
    {% endif %}

    {% if latest_resource %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Date collected newest resource
      </dt>
      <dd class="govuk-summary-list__value">
        {{ latest_resource['start_date'] }}
      </dd>
    </div>
    {% endif %}
    
  </dl>

  <div class="govuk-tabs" data-module="dlf-subnav">
    <h2 class="govuk-tabs__title">
      Contents
    </h2>
    <nav class="dlf-subnav" aria-label="Sub navigation">
      <ul class="dlf-subnav__list">
        <li class="dlf-subnav__list-item">
          <a class="dlf-subnav__list-item__link" href="#sources-resources" data-module-sub-nav="tab">
          Sources and resources
          </a>
        </li>
        {% if publishers %}
        <li class="dlf-subnav__list-item dlf-subnav__list-item--selected">
          <a class="dlf-subnav__list-item__link" href="#publishers" data-module-sub-nav="tab">
          Publishers
          </a>
        </li>
        {% endif %}
      </ul>
    </nav>

    <div id="sources-resources">
    {{ sourcesAndResourcesByMonthChart({}) }}

    
    {% if no_doc_url|length > 0 %}
    <h3 id="sources-missing-documentation-url" class="govuk-heading-m">Missing documentation urls</h3>
    <p class="govuk-body">{{ no_doc_url|length }} active sources are missing <code>documentation-urls</code>.</p>
    <ul class="govuk-list">
    {# only want to show 5 sources #}
    {% set items = no_doc_url|length if no_doc_url|length < 5 else 5 %}
    {% for n in range(items) %}
      <li class="data-record govuk-!-margin-bottom-3">
        <h4 class="govuk-heading-s data-record__identifier govuk-!-margin-bottom-0">Source <a href="{{ url_for('base.source', source=no_doc_url[n]['source']) }}">{{ no_doc_url[n]['source'] }}</a></h4>
        <dl class="govuk-summary-list data-record__properties govuk-!-margin-bottom-0">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Organisation</dt>
            <dd class="govuk-summary-list__value">{{ no_doc_url[n]['organisation_name'] }}</dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Endpoint url</dt>
            <dd class="govuk-summary-list__value"><a href="{{ no_doc_url[n]['endpoint_url'] }}">{{ no_doc_url[n]['endpoint_url'] }}</a></dd>
          </div>
        </dl>
      </li>
    {% endfor %}
    </ul>
    {% if no_doc_url|length > 5 %}
    <p class="govuk-body">
      <a href="{{ url_for('base.sources', dataset=name) }}" class="govuk-link">See all {{ name }} sources missing a <code>documentation-url</code></a>.
    </p>
    {% endif %}
    {% endif %}
    <h3 id="content-types" class="govuk-heading-m govuk-!-margin-top-9">Resource content-types</h3>
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-half">
        <div class="data-item govuk-!-margin-bottom-6">
          <span class="data-item__number govuk-!-font-size-48">{{ content_type_counts|length }}</span>
          <p class="govuk-body govuk-!-font-size-19">Content types</p>
        </div>
        <details class="govuk-details" data-module="govuk-details">
          <summary class="govuk-details__summary">
            <span class="govuk-details__summary-text dl-small-text">
              What does this tell us?
            </span>
          </summary>
          <div class="govuk-details__text dl-small-text">
            The higher the number of different content-types, the more variety there is in the types of resource we have to process. It is easier to process, extract and combine data from the same type of resource.
          </div>
        </details>
      </div>
      <div class="govuk-grid-column-one-half">
        {% if content_type_counts|length > 0 %}
        <ul class="govuk-list">
          <h4 class="govuk-heading-xs">Most common types</h4>
          {# only want to show most common types #}
          {% set items = content_type_counts|length if content_type_counts|length < 4 else 4 %}
          {% for n in range(items) %}
            <li>
              {% if content_type_counts[n]['content_type'] %}
              <span class="govuk-!-font-weight-bold">{{ content_type_counts[n]['content_type'] }}</span>: 
              {% else %}
              <span class="govuk-tag govuk-tag--yellow">No content-type</span> 
              {% endif %}
            {{ content_type_counts[n]['resource_count'] }} resource{{ "" if content_type_counts[n]['resource_count'] == 1 else "s" }}
            </li>
          {% endfor %}
          </ul>
          <a href="{{ url_for('base.content_types', pipeline=name) }}" class="govuk-link">See all content types</a>
          {% endif %}
      </div>
    </div>
    </div>

    <div id="publishers">
      {% if publishers %}
      <h2 class="govuk-heading-l">Publishers</h2>

      <figure class="highcharts-figure govuk-!-margin-bottom-9 govuk-grid-row">
        <div class="govuk-grid-column-one-quarter">
          <p class="govuk-body highcharts-description govuk-!-padding-top-9">
          Chart showing the number of active resources per publishers. Ideally each publisher would have only 1 active resource, then we can be confident this is the resource containing the latest data.
          </p>
        </div>
        <div class="govuk-grid-column-three-quarters">
          <div id="resource-count-chart"></div>
        </div>
      </figure>

      <h3 class="govuk-heading-m">Who has an active resource?</h3>
      <div class="govuk-accordion" data-module="govuk-accordion" id="accordion-default">
        <div class="govuk-accordion__section ">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-default-heading-1">
                {{ publishers['active']|length }} publishers with an active resource
              </span>
            </h2>
          </div>
          <div id="accordion-default-content-1" class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-1">
            {{ orgTableOnDataset({
              "caption": "Publishers with an active resource",
              "organisations": publishers['active'],
              "today": today
            }) }}
          </div>
        </div>
        <div class="govuk-accordion__section ">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-default-heading-1">
                {{ publishers['noactive']|length }} publishers with NO active resource
              </span>
            </h2>
          </div>
          <div id="accordion-default-content-1" class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-1">
            {{ orgTableOnDataset({
              "caption": "Publishers without an active resource",
              "organisations": publishers['noactive'],
              "today": today
            }) }}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

</main>
{% endblock %}

{% block bodyEnd %}
{{ super() }}
{% include 'partials/high-charts-scripts.html' %}
<script>
  console.log({{ dataset|tojson }})
</script>

<script>
  const $subNavTabs = document.querySelector('[data-module="dlf-subnav"]')
  const subNavTabsComponent = new DLFrontend.SubNavTabs($subNavTabs).init({})
</script>

<script src="/static/javascripts/vendor/jquery-3.4.1.min.js"></script>
<script src="/static/javascripts/vendor/MOJFrontend.SortableTable.js"></script>

{% if monthly_counts %}
{{ sourcesAndResourcesByMonthJS({
  "months": monthly_counts['months']|tojson,
  "resources": monthly_counts['resources']|tojson,
  "sources": monthly_counts['sources']|tojson
}) }}
{% else %}
<p class="govuk-body">No sources and resources for {{name|replace("-", " ")|capitalize}}.</p>
{% endif %}

<script>
(function($) {
    $(function() {
      var tables = document.querySelectorAll('table')
      tables.forEach(function(table) {
        var sTable = new MOJFrontend.SortableTable({
            table: $(table),
            statusVisible: true,
            tableWrapperSelector: ".data-table__wrapper"
        });
      })
    });
}(jQuery));
</script>
{% if resource_stats %}
<script>
  Highcharts.chart('resource-count-chart', {
  chart: {
    type: 'bar'
  },
  title: {
    text: 'Active resources per publisher'
  },
  xAxis: {
    categories: ['Active resources'],
    title: {
      text: null
    }
  },
  yAxis: {
    min: 0,
    title: {
      text: 'Organisations',
      align: 'high'
    },
    labels: {
      overflow: 'justify'
    }
  },
  tooltip: {
    valueSuffix: ' organisations'
  },
  plotOptions: {
    bar: {
      dataLabels: {
        enabled: true
      }
    }
  },
  legend: {
    layout: 'vertical',
    align: 'right',
    verticalAlign: 'top',
    x: -40,
    y: 80,
    floating: true,
    borderWidth: 1,
    backgroundColor:
      Highcharts.defaultOptions.legend.backgroundColor || '#FFFFFF',
    shadow: true
  },
  credits: {
    enabled: false
  },
  series: [{
    name: 'More than 1',
    data: [{{ resource_stats['over_one'] }}],
    color: '#ffdd00'
  }, {
    name: '1',
    data: [{{ resource_stats['one'] }}],
    color: '#003078'
  }, {
    name: 'None',
    data: [{{ resource_stats['zero'] }}],
    color: '#d4351c'
  }]
});
</script>
{% endif %}
{% endblock bodyEnd %}

