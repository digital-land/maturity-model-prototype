{% extends "layouts/layout.html" %}
{% block page_title %}Brownfield land | Dataset performance | Maturity Model | Digital Land{% endblock %}
{%- from "digital-land-frontend/components/feedback-panel/macro.html" import dlFeedbackPanel %}

{% block content %}
<main id="content" role="main">
  <span class="govuk-caption-xl">Dataset performance</span>
  <h1 class="govuk-heading-xl">{{ name }}</h1>

  
  <h3 class="govuk-heading-m">Dataset info</h3>

  <dl class="govuk-summary-list">

    {% if dataset['name'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Name
      </dt>
      <dd class="govuk-summary-list__value">
        {{ dataset['name'] }}
      </dd>
    </div>
    {% endif %}

    {% if dataset['project'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Project
      </dt>
      <dd class="govuk-summary-list__value">
        <a href="https://digital-land.github.io/project'{{ dataset['project'] }}">{{ dataset['project'] }}</a>
      </dd>
    </div>
    {% endif %}

    {% if dataset['pipeline'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Pipeline
      </dt>
      <dd class="govuk-summary-list__value">
        <a href="https://github.com/digital-land/{{ dataset['pipeline'] }}">{{ dataset['pipeline'] }}</a>
      </dd>
    </div>
    {% endif %}

    {% if dataset['data-provider'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Data provider
      </dt>
      <dd class="govuk-summary-list__value">
        {{ dataset['data-provider'] }}
      </dd>
    </div>
    {% endif %}

    {% if dataset['category'] %}
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">
        Category
      </dt>
      <dd class="govuk-summary-list__value">
        {{ dataset['category'] }}
      </dd>
    </div>
    {% endif %}
    
  </dl>

  {% if orgs %}
  <h2 class="govuk-heading-l govuk-!-margin-top-9">By publisher</h2>

  <figure class="highcharts-figure govuk-!-margin-bottom-9 govuk-grid-row">
    <div class="govuk-grid-column-one-quarter">
      <p class="govuk-body highcharts-description govuk-!-padding-top-9">
      Chart showing the number of active resources per publishers. Ideally each publisher would have only 1 active resource, then we can be confident this is the resource containing the latest data.
      </p>
    </div>
    <div class="govuk-grid-column-three-quarters">
      <div id="container"></div>
    </div>
  </figure>

  <div class="govuk-tabs" data-module="govuk-tabs">
    <h2 class="govuk-tabs__title">
      Contents
    </h2>
    <ul class="govuk-tabs__list">
      <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
        <a class="govuk-tabs__tab" href="#expected-orgs">
          Active
        </a>
      </li>
      <li class="govuk-tabs__list-item">
        <a class="govuk-tabs__tab" href="#no-resource">
          No active resource
        </a>
      </li>
    </ul>

    <div class="govuk-tabs__panel" id="expected-orgs">
      <div class="data-table__wrapper" data-module="data-table">
        <table class="govuk-table">
          <caption class="govuk-table__caption govuk-table__caption--m">Expected publishers</caption>
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th scope="col" class="govuk-table__header govuk-\!-width-one-quarter" aria-sort="none">Name</th>
              <th scope="col" class="govuk-table__header dl-cell-date" aria-sort="none">Total records</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Active sources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Inactive sources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Total resources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Active resources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Days since update</th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for org in orgs.withresource %}
            {% set total_resources = org['active-resource']|to_int + org['inactive-resource']|to_int %}
            {% set orgIdPieces = org['organisation'].split(':')  %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell" data-sort-value="{{ org['name'] }}"><a href="{{ url_for('base.organisation_performance', prefix=orgIdPieces[0], org_id=orgIdPieces[1]) }}" class="govuk-link">{{ org['name'] }}</a></td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['total-records']|to_int }}">{{ org['total-records'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['active-sources']|to_int }}">{{ org['active-sources'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['inactive-sources']|to_int }}">{{ org['inactive-sources'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ total_resources }}">{{ total_resources }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['active-resource']|to_int }}">{{ org['active-resource'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['days-since-new-resource-added']|to_int }}">{{ org['days-since-new-resource-added'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="govuk-tabs__panel" id="no-resource">
      <div class="data-table__wrapper" data-module="data-table">
        <table class="govuk-table">
          <caption class="govuk-table__caption govuk-table__caption--m">No active resource</caption>
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th scope="col" class="govuk-table__header govuk-\!-width-one-quarter" aria-sort="none">Name</th>
              <th scope="col" class="govuk-table__header dl-cell-date" aria-sort="none">Total records</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Active sources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Inactive sources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Total resources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Active resources</th>
              <th scope="col" class="govuk-table__header govuk-table__header--numeric" aria-sort="none">Days since update</th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for org in orgs.noresource %}
            {% set total_resources = org['active-resource']|to_int + org['inactive-resource']|to_int %}
            {% set orgIdPieces = org['organisation'].split(':')  %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell" data-sort-value="{{ org['name'] }}"><a href="{{ url_for('base.organisation_performance', prefix=orgIdPieces[0], org_id=orgIdPieces[1]) }}" class="govuk-link">{{ org['name'] }}</a></td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['total-records']|to_int }}">{{ org['total-records'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['active-sources']|to_int }}">{{ org['active-sources'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['inactive-sources']|to_int }}">{{ org['inactive-sources'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ total_resources }}">{{ total_resources }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['active-resource']|to_int }}">{{ org['active-resource'] }}</td>
              <td class="govuk-table__cell govuk-table__cell--numeric" data-sort-value="{{ org['days-since-new-resource-added']|to_int }}">{{ org['days-since-new-resource-added'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</main>
{% endblock %}

{% block bodyEnd %}
{{ super() }}
{% include 'partials/high-charts-scripts.html' %}
<script>
  console.log({{ dataset|tojson }})
</script>
<script src="/static/javascripts/vendor/jquery-3.4.1.min.js"></script>
<script src="/static/javascripts/vendor/MOJFrontend.SortableTable.js"></script>
<script>
(function($) {
    $(function() {
      var tables = document.querySelectorAll('table')
      tables.forEach(function(table) {
        var sTable = new MOJFrontend.SortableTable({
            table: $(table),
            statusVisible: true,
            tableWrapperSelector: ".data-table__wrapper"
        });
      })
    });
}(jQuery));
</script>
{% if resource_stats %}
<script>
  Highcharts.chart('container', {
  chart: {
    type: 'bar'
  },
  title: {
    text: 'Active resources per publisher'
  },
  xAxis: {
    categories: ['Active resources'],
    title: {
      text: null
    }
  },
  yAxis: {
    min: 0,
    title: {
      text: 'Organisations',
      align: 'high'
    },
    labels: {
      overflow: 'justify'
    }
  },
  tooltip: {
    valueSuffix: ' organisations'
  },
  plotOptions: {
    bar: {
      dataLabels: {
        enabled: true
      }
    }
  },
  legend: {
    layout: 'vertical',
    align: 'right',
    verticalAlign: 'top',
    x: -40,
    y: 80,
    floating: true,
    borderWidth: 1,
    backgroundColor:
      Highcharts.defaultOptions.legend.backgroundColor || '#FFFFFF',
    shadow: true
  },
  credits: {
    enabled: false
  },
  series: [{
    name: 'More than 1',
    data: [{{ resource_stats['over_one'] }}],
    color: '#ffdd00'
  }, {
    name: '1',
    data: [{{ resource_stats['one'] }}],
    color: '#003078'
  }, {
    name: 'None',
    data: [{{ resource_stats['zero'] }}],
    color: '#d4351c'
  }]
});
</script>
{% endif %}
{% endblock bodyEnd %}

