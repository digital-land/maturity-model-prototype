{% extends "ripa_test/base.html" %}
{% block page_title %}RIPA tests | Operations dashboard | Digital Land{% endblock %}
{% block dl_breadcrumbs %}{% endblock %}
{% block main %}
  <main class="app-main-wrapper govuk-main-wrapper {{ mainClasses }}" id="main-content" role="main"{% if mainLang %}
        lang="{{ mainLang }}"{% endif %}>
    <div>
      <h1 class="govuk-heading-m">Data test results &mdash; {% if date_of_test_run %}{{ date_of_test_run }}{% else %}no tests{% endif %}</h1>
    </div>
    {% block content %}
      {%  if results_grid %}
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
          <div class="app-c-test-grid">
            {% for la in local_authorities.keys() %}
              <div class="app-c-test-grid__row">
                <div class="app-c-test-grid__label">
                  {{ local_authorities[la] }}
                </div>
                <div class="app-c-test-grid__items">
                  {% for dataset, result in results_grid[la].items() %}
                    <div class="app-c-test-grid__item">
                      <span class="app-c-test-grid__result app-c-test-grid__result--{{ result | pass_fail }}">
                        <span>{% if result in [True, False] %}<a href="#{{ la }}-{{ dataset }}" style="color: inherit">{% endif %}{{ dataset | unhyphenate | capitalize }}{% if result  in [True, False] %}</a>{% endif %}</span>
                    <span class="app-c-test-grid__result-label">{{ result | pass_fail | capitalize }}</span>
                  </span>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
          <p><a href="{{ url_for("ripa.run_tests") }}" class="govuk-button">Run the tests again now</a></p>
        </div>
      </div>
      <div class="govuk-grid-row govuk-!-margin-top-4">
        <div class="govuk-grid-column-full">
          <h2 class="govuk-heading-l">Detailed results</h2>
        </div>
      </div>
      {% for result in results %}
        <div class="govuk-grid-row govuk-!-margin-bottom-5">
          <div class="govuk-grid-column-full">
              <h3  class="govuk-heading-m" id="{{ result.organisation}}-{{ result.dataset }}">{{ local_authorities[result.organisation] }}</h3>
              <p class="govuk-body-s">Test: {% if result.ticket %}<a href="{{ result.ticket }}">{% endif %}{{result.test_name}}{% if result.ticket %}</a>{% endif %}</p>
              <p class="govuk-body-s">Dataset: <a href="https://www.digital-land.info/dataset/{{ result.dataset }}">{{ result.dataset }}</a></p>
              <p class="govuk-body-s">Query: <a href="https://www.digital-land.info/entity.json{{result.query}}">{{result.query}}</a></p>
              <table class="govuk-table" id="{{ result.organisation}}-{{ result.dataset }}">
                <thead class="govuk-table__head">
                  <tr class="govuk-table__row govuk-body-s">
                    <th scope="col" class="govuk-table__header">Path</th>
                    <th scope="col" class="govuk-table__header">Expected</th>
                    <th scope="col" class="govuk-table__header">Actual</th>
                    <th scope="col" class="govuk-table__header">Status</th>
                  </tr>
                </thead>
                <tbody class="govuk-table__body">
                  {% for assertion in result.assertions %}
                    <tr class="govuk-table__row govuk-body-s">
                      <td class="govuk-table__cell">{{assertion.path}}</td>
                      <td class="govuk-table__cell">{{assertion.expected}}</td>
                      <td class="govuk-table__cell">{{assertion.actual}}</td>
                      {% if not assertion.match %}
                        <td class="govuk-table__cell app-c-test-grid-table__td app-c-test-grid-table__td--fail">fail</td>
                      {% else %}
                        <td class="govuk-table__cell app-c-test-grid-table__td app-c-test-grid-table__td--pass">pass</td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
          </div>
        </div>
      {% endfor %}
      {%  endif %}
    {% endblock content %}
  </main>
{% endblock main %}

{% block footer %}
  <div class="dl-sticky-banner__container" data-module="sticky-banner">
    <div class="dl-sticky-banner">
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half">
        </div>
      </div>
    </div>
  </div>
  {{ super() }}
{% endblock %}

{% block pageScripts %}
  {{ super() }}
{% endblock pageScripts %}
